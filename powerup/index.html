<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
</head>

<body>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-precise-range-plugin@1.3.0/moment-precise-range.min.js"></script>
  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    URL = "https://ai-way.herokuapp.com/"
    TrelloPowerUp.initialize({
      'card-buttons': function (t, options) {
        return [
          {
            icon: "https://i.ibb.co/6sbknH0/logo-stroke-32pt-style-2-no-stroke.png",
            text: "ID card",
            callback: function (t) {
              return t.card('all').then(card => {
                console.log(JSON.parse(JSON.stringify(card)))
                alert(`id: "${card.id}"`)
              })
            }
          },
          {
            icon: "https://cdn-icons-png.flaticon.com/512/709/709510.png",
            text: "complete",
            callback: function (t) {
              return t.card('all').then(card => {
                t.get("board", "shared", "complete").then(async idList => {
                  if (!idList) return t.alert("no list complete")
                  try {
                    var { data } = await axios.post(URL + 'card/complete', { idCard: card.id, idList })
                    t.alert("complete")
                  } catch (e) {
                    console.log(e)
                    t.alert("error !!")
                  }
                    
                })
              })
            },
          }
        ]
      },
      'board-buttons': function (t, options) {
        return [
          { 
            icon: "https://cdn-icons-png.flaticon.com/512/3524/3524659.png",
            text: "options",
            callback: function (t, opts) {
              t.popup({
                title: "options",
                items: [{
                  text: "settings",
                  callback: (t, opts) => t.popup({
                    title: "settings",
                    url: "./settings.html",
                    height: 140,
                  })
                }, {
                  text: "create linked cards",
                  callback: (t, opts) => t.popup({
                    title: "add cards",
                    url: "./addCards.html",
                    height: 140,
                  })
                }]
                /* url: './addCards.html',
                height: 184,
                width: 210, */
              })
            }
          }
        ]
      },
      'card-back-section': function(t, options){
        return {
          title: 'My Card Back Section',
          // icon: GRAY_ICON, // Must be a gray icon, colored icons not allowed.
          content: {
            type: 'iframe',
            url: t.signUrl('https://history-bac.netlify.app'),
            // url: './addCards.html',
            height: 230, // Max height is 1500.
          },
          action: {
            text: 'My Action',
            callback: (t) => t.popup({
              title: "title",
              url: "./addCards.html",
              height: 150
            }),
          }
        };
      },
      'list-actions':  t => {
          var lists = []
          t.lists("id", "name").then(listsp => lists = listsp)
          return t.list("all")
          .then(async list => {
            console.log("list", list)
            var listC = [null, null]
            var listInC = [null, null]
            console.log("start")
            s = await t.getAll("board", "shared")
            s = s.board.shared
            if (s.complete){
              listC[0] = s.complete
              listC[1] = lists.find(v => v.id == s.complete).name
            }
            if (s.incomplete) {
              listInC[0] = s.incomplete
              listInC[1] = lists.find(v => v.id == s.incomplete).name
            }
            var returnList = [{
                text: "Get List ID",
                callback: function (t) {
                console.log(list)
                alert(`list name: ${list.name}, ID: "${list.id}"`)
                }
            }];
            console.log(listC)
            if (list.id != listC[0] || list.id != listInC[0]) {
              returnList.push( {
                text: `move completed cards to "${listC[1]}"`,
                callback: t => {
                  var dueComplete = []
                  list.cards.forEach(card => {
                    if (card.dueComplete) dueComplete.push(card.id)
                  });
                  console.log(dueComplete)
                }
              })
              returnList.push( {
                  text: `move incompleted cards to "${listInC[1]}"`,
                  callback: t => {
                    var dueComplete = []
                    list.cards.forEach(card => {
                      if (!card.dueComplete && new Date(card.due) < new Date()) dueComplete.push(card.id)
                    });
                    console.log(dueComplete)
                  }
              })
            }
            console.log("-----")
            console.log(listC, listInC)
            return returnList
          });
      },
      'show-settings': function(t, options){
        return t.popup({
          title: 'Settings',
          url: './settings.html',
          height: 184 // we can always resize later
        });
      },
    })
  </script>
</body>
</html>